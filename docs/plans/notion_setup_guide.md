# Kurultai Notion Database Setup Guide

This guide explains how to configure your Notion database to work with Kurultai's Task Dependency Engine.

---

## Sync Modes

Kurultai supports two ways to sync with Notion:

| Mode | Triggered By | Best For |
|------|--------------|----------|
| **Command** | You send "Sync from Notion" | Manual control, predictable timing |
| **Polling** | Ögedei polls every N seconds | Hands-off, real-time updates |

Both modes use the same safety rules and database schema.

---

## Quick Start

### 1. Create the Database

1. In Notion, create a new database: **"Kurultai Tasks"**
2. Add these properties in order:

| Property | Type | Required | Select Options |
|----------|------|----------|----------------|
| `Name` | Title | ✅ | - |
| `ID` | Text | ✅ | - |
| `Status` | Select | ✅ | See below |
| `Priority` | Select | ✅ | See below |
| `Agent` | Multi-select | ✅ | See below |
| `SenderHash` | Text | ✅ | (Hidden - auto-filled) |
| `Type` | Select | ❌ | Research, Analysis, Code, Content, Strategy, Ops |
| `Duration` | Number | ❌ | Minutes (default: 15) |

### 2. Configure Select Options

#### Status Options (Must Match Exactly)

```
Not Started → pending
Blocked → blocked
Ready → ready
In Progress → in_progress
Completed → completed
Cancelled → aborted
```

#### Priority Options

```
Critical → 1.0
High → 0.8
Medium → 0.5
Low → 0.3
Backlog → 0.1
```

#### Agent Options

```
Research → researcher
Analysis → analyst
Development → developer
Writing → writer
Operations → ops
Strategy → analyst
```

### 3. Set Environment Variables

```bash
export NOTION_API_KEY="your_notion_integration_token"
export NOTION_DATABASE_ID="your_database_id_from_url"
```

**Get your API key:** https://www.notion.so/my-integrations

**Get your database ID:** From the URL when viewing your database:
```
https://notion.so/workspace/{DATABASE_ID}?v=...
                    ^^^^^^^^^^^^^^
```

### 4. Configure Polling (Optional)

For continuous polling by Ögedei, set the polling interval:

```bash
export NOTION_POLL_ENABLED="true"      # Enable polling (default: true)
export NOTION_POLL_INTERVAL="60"       # Seconds between polls (default: 60)
```

**Polling behavior:**
- Runs every N seconds in background
- Detects ALL changes: new tasks, priority, status, agents, descriptions
- Applies changes automatically using safety rules
- Sends Signal notifications on sync

### 5. Test Sync

Send to Kublai:
```
Sync from Notion
```

---

## Database Property Details

### Name (Title)
- **Type:** Title
- **Description:** Human-readable task description
- **Example:** "Research competitor pricing models"

### ID (Text)
- **Type:** Text
- **Description:** Unique task identifier (UUID)
- **Example:** "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
- **Note:** Auto-generated by Kurultai when creating tasks

### Status (Select)
- **Type:** Select
- **Options:** Not Started, Blocked, Ready, In Progress, Completed, Cancelled
- **Meaning:**
  - `Not Started` → Task is queued, waiting to be processed
  - `Blocked` → Task has unmet dependencies
  - `Ready` → Task can start immediately
  - `In Progress` → Agent is actively working
  - `Completed` → Task finished successfully
  - `Cancelled` → Task aborted by user or system

### Priority (Select)
- **Type:** Select
- **Options:** Critical, High, Medium, Low, Backlog
- **Weights:** 1.0, 0.8, 0.5, 0.3, 0.1
- **Usage:** Higher priority = executed first when safe

### Agent (Multi-select)
- **Type:** Multi-select
- **Options:** Research, Analysis, Development, Writing, Operations, Strategy
- **Maps to:**
  - Research → Möngke (researcher)
  - Analysis → Jochi (analyst)
  - Development → Temüjin (developer)
  - Writing → Chagatai (writer)
  - Operations → Ögedei (ops)
  - Strategy → Jochi (analyst)

### SenderHash (Text)
- **Type:** Text
- **Description:** HMAC-SHA256 of user's phone number
- **Visibility:** Hide this column (it's for internal matching)
- **Note:** Never edit this manually

### Type (Select) - Optional
- **Type:** Select
- **Options:** Research, Analysis, Code, Content, Strategy, Ops
- **Usage:** Helps determine deliverable structure

### Duration (Number) - Optional
- **Type:** Number
- **Unit:** Minutes
- **Default:** 15
- **Usage:** Estimated time for completion

---

## Example Tasks

| Name | Status | Priority | Agent | Type | Duration |
|------|--------|----------|-------|------|----------|
| Research competitors | Not Started | High | Research | Research | 20 |
| Build landing page | Not Started | High | Development | Code | 45 |
| Write launch announcement | Blocked | Medium | Writing | Content | 15 |
| Analyze pricing strategy | Ready | Critical | Analysis | Strategy | 30 |

---

## Sync Behavior

### What Syncs FROM Notion → Kurultai

| Field | Syncs? | Notes |
|-------|--------|-------|
| **Status** | ✅ | Except for In Progress/Completed tasks |
| **Priority** | ✅ | Always safe to change |
| **Agent** | ✅ | Reassignment if not In Progress |
| **Description** | ✅ | Task title/description updates |
| **Type** | ✅ | Deliverable type |
| **Duration** | ✅ | Estimated time |
| **Deletions** | ✅ | Archived (not hard deleted) |

### What Does NOT Sync

- **In Progress tasks**: Never interrupted (status changes ignored)
- **Completed tasks**: Never reverted (status changes ignored)
- **Dependencies**: Must be edited via natural language commands

### Safety Rules

1. **In Progress Protection**: Tasks marked "In Progress" ignore Notion status changes
2. **Completed Protection**: Tasks marked "Completed" are never reverted
3. **Dependency Validation**: Can't set task to "Ready" if dependencies are blocked
4. **Agent Reassignment**: Only if task is not In Progress
5. **Deletion**: Soft delete (archive) in Neo4j, not hard delete

---

## Common Workflows

### Reprioritize Work

**Command mode:**
1. In Notion, change Priority column
2. Send "Sync from Notion" to Kublai
3. Kublai confirms new execution order

**Polling mode:**
1. In Notion, change Priority column
2. Wait up to 60 seconds (or your configured interval)
3. Ögedei applies change automatically, sends notification

### Add New Tasks

1. In Notion, add new row with:
   - Name: Task description
   - ID: Leave blank (auto-generated)
   - Status: Not Started
   - Priority: Choose level
   - Agent: Choose specialist
2. Sync/Poll → Task created in Kurultai DAG as "pending_review"
3. Kublai reviews and activates task

### Cancel Task

1. In Notion, change Status to "Cancelled"
2. Sync → Task aborted in Kurultai

### View Current State

Send to Kublai:
```
What's the plan?
```

---

## Polling Configuration

### Enable/Disable Polling

**Globally:**
```bash
export NOTION_POLL_ENABLED="true"   # Enable
export NOTION_POLL_ENABLED="false"  # Disable
```

**Per user:** (stored in Neo4j)
```cypher
// Enable polling for user
MATCH (u:UserConfig {sender_hash: $hash})
SET u.notion_poll_enabled = true

// Disable polling for user
MATCH (u:UserConfig {sender_hash: $hash})
SET u.notion_poll_enabled = false
```

### Adjust Polling Interval

```bash
export NOTION_POLL_INTERVAL="30"    # Poll every 30 seconds
export NOTION_POLL_INTERVAL="120"   # Poll every 2 minutes
```

**Recommended intervals:**
- **30 seconds**: Near real-time, higher API usage
- **60 seconds**: Balanced (default)
- **300 seconds** (5 min): Lower API usage, acceptable delay

### Notifications on Change

Control whether Ögedei sends Signal notifications when changes are detected:

```cypher
// Enable notifications
MATCH (u:UserConfig {sender_hash: $hash})
SET u.notion_notify_on_change = true

// Disable notifications (silent sync)
MATCH (u:UserConfig {sender_hash: $hash})
SET u.notion_notify_on_change = false
```

---

## Troubleshooting

### "Failed to connect to Notion"

**Cause:** Invalid API key or database ID

**Fix:**
1. Regenerate API token at https://www.notion.so/my-integrations
2. Copy database ID from URL (32-character string)
3. Verify environment variables are set

### "Task exists in Kurultai but not in Notion"

**Cause:** Task was created via natural language, not synced

**Fix:** Add the task to Notion manually using the ID shown in the message

### "Cannot set to READY: dependencies not met"

**Cause:** Task has unmet BLOCKS dependencies

**Fix:**
1. Complete or cancel dependent tasks first, OR
2. Use natural language: "These are independent"

### Sync returns "Everything up to date" but you made changes

**Cause:** Changes were already synced, or SenderHash doesn't match

**Fix:**
1. Verify SenderHash column matches your registered phone
2. Check that you edited the correct database row

---

## Advanced: Bidirectional Sync (Future)

Currently, sync is **Notion → Kurultai only**:
- **Command mode**: Triggered by "Sync from Notion"
- **Polling mode**: Ögedei polls automatically every N seconds

Future versions will support:
- **Kublai → Notion**: Auto-create tasks in Notion when generated by agents
- **Real-time sync**: Webhook-based instant updates
- **Conflict resolution**: Smart merging when both sides changed

---

*End of Guide*
