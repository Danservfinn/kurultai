# Moltbot Railway Template - Deployment Configuration
# OpenClaw Gateway with built-in webchat UI
# https://docs.railway.com/deploy/config-as-code

[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"
watchPatterns = ["Dockerfile", "entrypoint.sh", "src/**", "routes/**", "middleware/**", "config/**", "package*.json"]

[build.args]
CACHE_BUST = "2026-02-12-v1-FIXED-WEBSOCKET-SIGNAL"

[deploy]
# Health check - OpenClaw gateway health endpoint
healthcheckPath = "/health"
healthcheckTimeout = 120
healthcheckInterval = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# Resource allocation
numReplicas = 1

# Keep running
sleepApplication = false

# Cron schedules for background tasks
[[deploy.crons]]
name = "kurultai-heartbeat"
schedule = "*/5 * * * *"  # Every 5 minutes
command = "cd /app && python tools/kurultai/heartbeat_master.py --cycle"

[[deploy.crons]]
name = "jochi-smoke-tests"
schedule = "*/15 * * * *"  # Every 15 minutes
command = "cd /app && python tools/kurultai/test_runner_orchestrator.py --phase fixtures --phase integration --dry-run"

[[deploy.crons]]
name = "jochi-hourly-tests"
schedule = "0 * * * *"  # Every hour
command = "cd /app && python tools/kurultai/test_runner_orchestrator.py --dry-run"

[[deploy.crons]]
name = "jochi-nightly-tests"
schedule = "0 2 * * *"  # 2 AM daily
command = "cd /app && python tools/kurultai/test_runner_orchestrator.py --phase all --dry-run"

[[deploy.crons]]
name = "kublai-weekly-reflection"
schedule = "0 20 * * 0"  # Sundays at 8 PM ET
command = "cd /app && curl -X POST http://localhost:8082/api/reflection/trigger -H 'Content-Type: application/json' -d '{}' || echo 'Reflection trigger endpoint not available'"

[deploy.env]
# Signal Configuration
SIGNAL_ENABLED = "true"
SIGNAL_DATA_DIR = "/data/.local/share/signal-cli"
SIGNAL_CLI_PATH = "/usr/local/bin/signal-cli"

# OpenClaw Gateway Configuration
NODE_ENV = "production"
OPENCLAW_GATEWAY_PORT = "18789"
OPENCLAW_STATE_DIR = "/data/.openclaw"

[deploy.volumes]
# Persistent storage for Signal (must match signal-cli default location)
signal-data = "/data/.local/share/signal-cli"
logs = "/data/logs"
