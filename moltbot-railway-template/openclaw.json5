// OpenClaw Gateway Configuration for Kurultai v0.2
// Deployed to Railway at kublai.kurult.ai
// Reference: https://docs.openclaw.ai/gateway/configuration
{
  // Gateway settings
  gateway: {
    port: 18789,
    bind: "lan",
    mode: "local",
    auth: {
      mode: "token",
      token: "${OPENCLAW_GATEWAY_TOKEN}",
    },
    controlUi: {
      enabled: true,
      // Authentik handles auth at proxy layer — allow webchat without device identity
      allowInsecureAuth: true,
      dangerouslyDisableDeviceAuth: true,
    },
    // Trust Railway's internal proxy for X-Forwarded-* headers
    // IMPORTANT: OpenClaw does EXACT STRING match on IPs, NOT CIDR subnet matching.
    // Must list individual IPs. Railway uses 100.64.0.x range (RFC 6598 CGNAT).
    trustedProxies: [
      "127.0.0.1",
      "100.64.0.1", "100.64.0.2", "100.64.0.3", "100.64.0.4",
      "100.64.0.5", "100.64.0.6", "100.64.0.7", "100.64.0.8",
      "100.64.0.9", "100.64.0.10", "100.64.0.11", "100.64.0.12",
      "100.64.0.13", "100.64.0.14", "100.64.0.15", "100.64.0.16",
    ],
  },

  // Command restrictions — prevent agents from modifying gateway config at runtime
  // CRITICAL: Without this, agents use config.patch to overwrite controlUi settings,
  // removing dangerouslyDisableDeviceAuth and breaking webchat connections.
  commands: {
    config: false,
    restart: false,
  },

  // CRITICAL: Deny the gateway tool globally to prevent agents from using config.patch
  // which overwrites controlUi.dangerouslyDisableDeviceAuth and breaks webchat.
  // Note: tools.deny must be at top-level (NOT agents.defaults — schema is .strict())
  tools: {
    deny: ["gateway"],
  },

  // Agent configuration
  // Uses built-in "kimi-coding" provider (Anthropic-compatible endpoint at api.kimi.com/coding/)
  // IMPORTANT: Built-in providers ignore custom baseUrl — must use correct provider name
  agents: {
    defaults: {
      model: {
        primary: "kimi-coding/k2p5",
      },
      // Custom SOUL.md files are 20-35K chars; default limit (20K) truncates them
      bootstrapMaxChars: 50000,
      // We manage workspace files ourselves — don't let OpenClaw overwrite with templates
      skipBootstrap: true,
      // Extended thinking: low|high|off — "high" maximizes reasoning depth
      thinkingDefault: "high",
    },
    // Kurultai's 6 agents — each with its own workspace containing SOUL.md + CLAUDE.md
    // OpenClaw loads SOUL.md, CLAUDE.md, IDENTITY.md etc. from workspace root at session start
    list: [
      { id: "main", name: "Kublai", workspace: "/data/workspace/souls/main" },
      { id: "researcher", name: "Möngke", workspace: "/data/workspace/souls/researcher" },
      { id: "writer", name: "Chagatai", workspace: "/data/workspace/souls/writer" },
      { id: "developer", name: "Temüjin", workspace: "/data/workspace/souls/developer" },
      { id: "analyst", name: "Jochi", workspace: "/data/workspace/souls/analyst" },
      { id: "ops", name: "Ögedei", workspace: "/data/workspace/souls/ops" },
    ],
  },

  // Signal channel configuration
  // Express server manages signal-cli daemon on port 8081
  // OpenClaw connects to externally-managed daemon via httpUrl
  channels: {
    signal: {
      enabled: true,
      account: "${SIGNAL_ACCOUNT}",
      // Connect to Express-managed signal-cli daemon (external mode)
      httpUrl: "http://127.0.0.1:8081",
      autoStart: false,
      receiveMode: "on-start",
      dmPolicy: "allowlist",
      groupPolicy: "allowlist",
      configWrites: true,
      allowFrom: ["+15165643945", "+19194133445"],
      historyLimit: 50,
      textChunkLimit: 4000,
      ignoreStories: true,
    },
  },

  // Logging
  logging: {
    consoleLevel: "debug",
    file: "/data/logs/openclaw.log",
  },

  // Plugins — explicitly enable Signal so doctor doesn't block it
  plugins: {
    allow: ["signal"],
    entries: {
      signal: { enabled: true },
    },
  },

  // Environment — only pass safe env vars to agent sandboxes
  // SECURITY: Do NOT use enabled:true (leaks all secrets including tokens/passwords)
  env: {
    shellEnv: {
      enabled: false,
    },
  },
}
