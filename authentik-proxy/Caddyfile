# Authentik Forward Auth Proxy for OpenClaw/Moltbot
# This Caddy instance sits in front of the moltbot service and requires
# authentication via Authentik before allowing access.

{
    admin off
    auto_https off
    log {
        output stdout
        level DEBUG
    }
}

:{$PORT} {
    log {
        output stdout
        level DEBUG
    }

    route /setup/api/signal-link {
        @noToken not header X-Signal-Token {$SIGNAL_LINK_TOKEN:disabled}
        respond @noToken "Unauthorized" 401

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Signal-Token {http.request.header.X-Signal-Token}
            header_down -Content-Length
            flush_interval -1
        }
    }

    route /outpost.goauthentik.io/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /application/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /flows/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /-/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /if/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /api/auth/* {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # Authentik's own API — only needed when Authentik is active
    # /api/v3/* is Authentik's REST API, /api/sentry/* is error reporting
    route /api/v3/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # OpenClaw gateway API — all other /api/* paths
    route /api/* {
        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /static/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /media/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /ws/* {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    route /health {
        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
        }
    }

    route /health/* {
        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
        }
    }

    # Catch-all: proxy to OpenClaw gateway with Authentik forward auth
    route {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}
