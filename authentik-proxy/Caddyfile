# Authentik Forward Auth Proxy for OpenClaw/Moltbot
# This Caddy instance sits in front of the moltbot service and requires
# authentication via Authentik before allowing access.

{
    # Global options
    admin off
    auto_https off
    log {
        output stdout
        level DEBUG
    }
    # Rate limiting for auth endpoints (using Caddy's http.ratelimit module if available)
    # Fallback: Authentik has built-in rate limiting configured via API
}

# Listen on the Railway-assigned port
:{$PORT} {
    log {
        output stdout
        level DEBUG
    }

    # Rate limit all requests (generous limit for normal use)
    # Note: Requires github.com/RussellLuo/caddy-ext/ratelimit or similar
    # For now, we rely on Authentik's built-in rate limiting

    # Signal SSE endpoint with token-based authentication
    # The page itself is protected, but we add a secret token check for API access
    handle /setup/api/signal-link {
        # Check for valid secret token in header (set by the protected page)
        @noToken {
            header !X-Signal-Token {$SIGNAL_LINK_TOKEN}
        }
        respond @noToken "Unauthorized" 401

        reverse_proxy moltbot.railway.internal:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Signal-Token {http.request.header.X-Signal-Token}
            # Enable SSE streaming
            header_down -Content-Length
            # Keep connection alive for SSE
            flush_interval -1
        }
    }

    # Forward authentication to Authentik's embedded outpost
    forward_auth authentik-server.railway.internal:9000 {
        uri /outpost.goauthentik.io/auth/caddy

        # Headers that Authentik needs to identify the request
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Uri {uri}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Method {method}

        # Copy authentication headers from Authentik response to upstream
        copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*

        # Trust Railway's internal network
        trusted_proxies private_ranges
    }

    # Reverse proxy to the moltbot service
    reverse_proxy moltbot.railway.internal:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto https
    }

    # Handle errors
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}
