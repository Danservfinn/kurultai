# Authentik Forward Auth Proxy for OpenClaw/Moltbot
# This Caddy instance sits in front of the moltbot service and requires
# authentication via Authentik before allowing access.

{
    admin off
    auto_https off
    log {
        output stdout
        level DEBUG
    }
}

:{$PORT} {
    log {
        output stdout
        level DEBUG
    }

    # Use handle_path blocks with explicit ordering via numeric prefixes in comments
    # Caddy sorts handle blocks by path specificity, so we use path_regexp for complex matching

    # 1. Signal linking endpoint (token-protected, no auth)
    handle_path /setup/api/signal-link {
        @noToken not header X-Signal-Token {$SIGNAL_LINK_TOKEN:disabled}
        respond @noToken "Unauthorized" 401

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Signal-Token {http.request.header.X-Signal-Token}
            header_down -Content-Length
            flush_interval -1
        }
    }

    # 2. Health checks - go to Express API (NO AUTH for health)
    # Use handle with explicit matcher to preserve path
    handle /health* {
        reverse_proxy moltbot-railway-template.railway.internal:8082 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 3. Express API routes - using /express prefix to avoid conflict with /api
    # External: /express/api/proposals → Internal: /api/proposals
    # External: /express/api/migrate-proposals → Internal: /api/migrate-proposals
    handle_path /express/* {
        reverse_proxy moltbot-railway-template.railway.internal:8082 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 5. Authentik API (NO AUTH - Authentik handles its own auth)
    handle_path /api/v3/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 6. Authentik outpost routes (NO AUTH)
    handle_path /outpost.goauthentik.io/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /application/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /flows/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /-/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /if/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /static/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_path /media/* {
        reverse_proxy authentik-server.railway.internal:9000 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 7. WebSocket endpoint (WITH AUTH)
    handle_path /ws/* {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 8. Other API routes - OpenClaw (WITH AUTH)
    # This MUST come after /express/* routes
    handle_path /api/* {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    # 9. Catch-all: proxy to OpenClaw gateway with Authentik forward auth
    handle {
        forward_auth authentik-server.railway.internal:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Uri {uri}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Method {method}
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Meta-*
            trusted_proxies private_ranges
        }

        reverse_proxy moltbot-railway-template.railway.internal:18789 {
            header_up Host {host}
            header_up X-Real-Ip {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
        }
    }

    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}
