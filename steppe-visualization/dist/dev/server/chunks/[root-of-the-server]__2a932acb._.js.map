{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/kurultai/molt/steppe-visualization/app/api/tasks/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { promises as fs } from 'fs';\nimport path from 'path';\n\n// Local workspace path for development\nconst WORKSPACE_PATH = process.env.WORKSPACE_PATH || '/Users/kurultai/molt/data/workspace';\n\n// Task directories\nconst TASK_DIRS = {\n  inbox: 'tasks/inbox',\n  assigned: 'tasks/assigned',\n  inProgress: 'tasks/in-progress',\n  review: 'tasks/review',\n  done: 'tasks/done',\n};\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\ninterface TaskFile {\n  path: string;\n  status: keyof typeof TASK_DIRS;\n  content: string;\n  metadata?: {\n    title?: string;\n    assignedTo?: string;\n    priority?: string;\n    created?: string;\n  };\n}\n\nasync function readTaskFiles(dir: string, status: keyof typeof TASK_DIRS): Promise<TaskFile[]> {\n  const fullPath = path.join(WORKSPACE_PATH, dir);\n\n  try {\n    await fs.access(fullPath);\n  } catch {\n    return []; // Directory doesn't exist\n  }\n\n  const tasks: TaskFile[] = [];\n\n  try {\n    const entries = await fs.readdir(fullPath, { withFileTypes: true });\n\n    for (const entry of entries) {\n      if (entry.isFile() && entry.name.endsWith('.md')) {\n        const filePath = path.join(fullPath, entry.name);\n        const content = await fs.readFile(filePath, 'utf-8');\n\n        // Parse metadata from frontmatter or content\n        const metadata = parseTaskMetadata(content);\n\n        tasks.push({\n          path: path.join(dir, entry.name),\n          status,\n          content,\n          metadata,\n        });\n      }\n    }\n  } catch (error) {\n    // Silently fail if directory read fails\n  }\n\n  return tasks;\n}\n\nfunction parseTaskMetadata(content: string) {\n  const metadata: Record<string, string> = {};\n\n  // Look for common task patterns\n  const titleMatch = content.match(/^#\\s+(.+)$/m);\n  if (titleMatch) metadata.title = titleMatch[1];\n\n  const assignedMatch = content.match(/\\*\\*Assigned To\\*\\*:\\s*(.+)$/m);\n  if (assignedMatch) metadata.assignedTo = assignedMatch[1];\n\n  const priorityMatch = content.match(/\\*\\*Priority\\*\\*:\\s*(\\w+)$/m);\n  if (priorityMatch) metadata.priority = priorityMatch[1];\n\n  const createdMatch = content.match(/\\*\\*Created\\*\\*:\\s*(.+)$/m);\n  if (createdMatch) metadata.created = createdMatch[1];\n\n  return metadata;\n}\n\nexport async function GET() {\n  const allTasks: TaskFile[] = [];\n\n  // Read from all task directories\n  for (const [status, dir] of Object.entries(TASK_DIRS)) {\n    const tasks = await readTaskFiles(dir, status as keyof typeof TASK_DIRS);\n    allTasks.push(...tasks);\n  }\n\n  // Group by agent\n  const tasksByAgent: Record<string, TaskFile[]> = {};\n\n  for (const task of allTasks) {\n    const assignedTo = task.metadata?.assignedTo?.toLowerCase() || '';\n    const agentId = mapAssignedToAgentId(assignedTo);\n\n    if (!tasksByAgent[agentId]) {\n      tasksByAgent[agentId] = [];\n    }\n    tasksByAgent[agentId].push(task);\n  }\n\n  return NextResponse.json({\n    tasks: allTasks,\n    tasksByAgent,\n    summary: {\n      total: allTasks.length,\n      byStatus: Object.entries(TASK_DIRS).reduce((acc, [status, dir]) => {\n        acc[status] = allTasks.filter(t => t.status === dir).length;\n        return acc;\n      }, {} as Record<string, number>),\n    }\n  });\n}\n\nfunction mapAssignedToAgentId(assignedTo: string): string {\n  const mapping: Record<string, string> = {\n    'kublai': 'kublai',\n    '@kublai': 'kublai',\n    'mongke': 'mongke',\n    '@mongke': 'mongke',\n    'ögedei': 'ogedei',\n    'ogedei': 'ogedei',\n    '@ogedei': 'ogedei',\n    'temüjin': 'temujin',\n    'temujin': 'temujin',\n    '@temujin': 'temujin',\n    'jochi': 'jochi',\n    '@jochi': 'jochi',\n    'chagatai': 'chagatai',\n    '@chagatai': 'chagatai',\n  };\n\n  return mapping[assignedTo] || 'unassigned';\n}\n"],"names":[],"mappings":"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"}}]
}